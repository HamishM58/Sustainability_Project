/*
  This is a library written for the AS726X Spectral Sensor (Visible or IR) with I2C firmware
  specially loaded. SparkFun sells these at its website: www.sparkfun.com

  Written by Nathan Seidle & Andrew England @ SparkFun Electronics, July 12th, 2017

  https://github.com/sparkfun/Qwiic_Spectral_Sensor_AS726X

  Do you like this library? Help support SparkFun. Buy a board!

  Development environment specifics:
  Arduino IDE 1.8.1

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.


  ---AVAILABLE FUNCTIONS---
  AS726X(TwoWire &wirePort = Wire, byte gain = 3, byte measurementMode = 3);
  void takeMeasurements();
  void takeMeasurementsWithBulb();
  void printMeasurements();
  byte getTemperature();
  float getTemperatureF();
  void setMeasurementMode(byte mode);
  boolean dataAvailable();
  void enableIndicator();
  void disableIndicator();
  void setIndicatorCurrent(byte current);
  void enableBulb();
  void disableBulb();
  void setBulbCurrent(byte current);
  void softReset();
  void setGain(byte gain);
  void setIntegrationTime(byte integrationValue);
  void enableInterrupt();
  void disableInterrupt();

  //Get the various color readings
  int getViolet();
  int getBlue();
  int getGreen();
  int getYellow();
  int getOrange();
  int getRed();

  //Get the various NIR readings
  int getR();
  int getS();
  int getT();
  int getU();
  int getV();
  int getW();

  //Returns the various calibration data
  float getCalibratedViolet();
  float getCalibratedBlue();
  float getCalibratedGreen();
  float getCalibratedYellow();
  float getCalibratedOrange();
  float getCalibratedRed();

  float getCalibratedR();
  float getCalibratedS();
  float getCalibratedT();
  float getCalibratedU();
  float getCalibratedV();
  float getCalibratedW();
*/
#include "AS726X.h"
#include "Wire.h"

AS726X sensor;
int bbyte = 0;

void setup() {
  Serial.begin(115200);
  while(!Serial);

  Wire.begin();
  while(Scan()==false);
  Serial.println("I2C connect!");
  delay(1000);
  while(sensor.begin()==false);
  Serial.println("AS726X Sensor connect!");
  delay(1000);
}

void loop() {
  if (Serial.available() > 0) {
    bbyte = Serial.read();
    IdentifyPlastic();
  }
}

void TakeReading(){
  delay(1000);
  sensor.enableBulb();
  delay(1000);
  sensor.takeMeasurements();
  delay(1000);
  sensor.disableBulb();
}

void PrintReading(){
  Serial.print("R:");
  Serial.println(sensor.getCalibratedR(), 2);
  Serial.print("S:");
  Serial.println(sensor.getCalibratedS(), 2);
  Serial.print("T:");
  Serial.println(sensor.getCalibratedT(), 2);
  Serial.print("U:");
  Serial.println(sensor.getCalibratedU(), 2);
  Serial.print("V:");
  Serial.println(sensor.getCalibratedV(), 2);
  Serial.print("W:");
  Serial.println(sensor.getCalibratedW(), 2);
  Serial.println();
}

void IdentifyPlastic(){
  TakeReading();
  delay(100);
  float R = sensor.getCalibratedR();
  float S = sensor.getCalibratedS();
  float T = sensor.getCalibratedT();
  float U = sensor.getCalibratedU();
  float V = sensor.getCalibratedV();
  float W = sensor.getCalibratedW();

  float RS = R/S;
  float ST = S/T;
  float TU = T/U;
  float UV = U/V;
  float VW = V/W;

  float Vector[5] = {RS,ST,TU,UV,VW};
  //Serial.println(String(Vector[0])+" "+String(Vector[1])+" "+String(Vector[2])+" "+String(Vector[3])+" "+String(Vector[4]));

  float VectorBelt[5] = {5.035,0.9175,3.4725,2.0175,2.31};
  float VectorHDPE[5] = {4.435,1.7025,3.13,1.34,1.6375};
  float VectorPP[5] = {18.442,0.598,6.2,1.072,2.586};
  float VectorPLA[5] = {2.964,2.396,2.39,1.364,1.498};
  float VectorPA[5] = {1,1,1,1,1};
  //float VectorERROR[5] = {0,0,0,0,0};

  //float VectorPETE[5] = {5.45,0.9775,4.57,1.44,1.925};
  

  float BELT = Edistance(Vector, VectorBelt);
  float HDPE = Edistance(Vector, VectorHDPE);
  float PP = Edistance(Vector, VectorPP);
  float PLA = Edistance(Vector, VectorPLA);
  float PA = Edistance(Vector, VectorPA);

  float minimum = min(min(min(BELT, HDPE),min(PP, PLA)),PA);
  if(minimum == BELT){
    Serial.println("BELT");
  }
  else if(minimum == HDPE){
    Serial.println("HDPE");
    sort(1);
  }
  else if(minimum == PP){
    Serial.println("PP");
    sort(2);
  }
  else if(minimum == PLA){
    Serial.println("PLA");
    sort(3);
  }
  else{
    Serial.println("Error, Not determined. Catch Bin");
    sort(10);
  }


  /*
  Serial.print("BELT: ");
  Serial.println(String(BELT));
  Serial.print("HDPE: ");
  Serial.println(String(HDPE));
  Serial.print("PP: ");
  Serial.println(String(PP));
  Serial.print("PLA: ");
  Serial.println(String(PLA));
  Serial.print("PA: ");
  Serial.println(String(PA));
  */
}
float Edistance(float* A, float* B) {
    float sum = 0;
    for (int i = 0; i < 5; i++) {
        float diff = A[i] - B[i];
        sum += diff * diff;
    }
    return sqrt(sum);
}


bool Scan(){
  byte error, address;
  int nDevices;
  Serial.println("Scanning...");
  nDevices = 0;
  for(address = 1; address < 127; address++ )
  {
    // The i2c_scanner uses the return value of
    // the Write.endTransmisstion to see if
    // a device did acknowledge to the address.
    Wire.beginTransmission(address);
    error = Wire.endTransmission();
    if (error == 0)
    {
      Serial.print("I2C device found at address 0x");
      if (address<16)
      Serial.print("0");
      Serial.println(address,HEX);
      return true;
      nDevices++;
    }
    else if (error==4)
    {
      Serial.print("Unknown error at address 0x");
      if (address<16)
        Serial.print("0");
      Serial.println(address,HEX);
    }    
  }
  if (nDevices == 0){
    Serial.println("No I2C devices found\n");
    return false;
  }
  else{
    Serial.println("done\n");
  }
  delay(1000);
}
